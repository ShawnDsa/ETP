<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>University Notification Dashboard</title>
  <style>
    :root{
      --bg:#0f1724; /* dark navy */
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#6ee7b7;
      --danger:#ff7b7b;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, #071021 0%, #071627 60%);
      color:#e6eef6;
      font-size:14px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }

    .app{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:20px;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:18px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }

    h1{margin:0 0 10px 0;font-size:20px}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px}
    input[type="text"], textarea, select {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:var(--glass);
      color:inherit;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:10px}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#4fd1c5);color:#042024;font-weight:600;cursor:pointer
    }
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04);}
    .muted{color:var(--muted)}

    /* list */
    .controls{display:flex;gap:8px;align-items:center}
    .list{
      display:flex;flex-direction:column;gap:12px;margin-top:12px;overflow:auto;padding-right:6px;max-height:72vh
    }
    .item{
      padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02);
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start
    }
    .meta{display:flex;flex-direction:column;gap:6px}
    .source{font-weight:700}
    .content{color:var(--muted);white-space:pre-wrap}
    .rightcol{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .badge{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .HIGH{background:linear-gradient(90deg,#ff9b9b,#ff7b7b);color:#3b0b0b}
    .MEDIUM{background:linear-gradient(90deg,#ffd38a,#ffcc66);color:#3b1b00}
    .LOW{background:linear-gradient(90deg,#b7f9d2,#6ee7b7);color:#052217}
    .small{font-size:12px;color:var(--muted)}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;padding:10px 14px;border-radius:8px;background:#0b1f2a;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(2,6,23,0.6);}

    footer{margin-top:14px;color:var(--muted);font-size:13px}

    @media (max-width:980px){
      .app{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h1>Send Notification</h1>
      <p class="muted">Post a notification to the classification backend. The backend will decide priority.</p>

      <label for="source">Source (e.g. Department / Sender)</label>
      <input id="source" type="text" placeholder="Ex: Computer Science Dept" />

      <label for="content">Message content</label>
      <textarea id="content" placeholder="Type the notification content (deadline, exam, meeting, etc.)"></textarea>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <button id="sendBtn" class="btn">Send</button>
        <button id="clearBtn" class="btn secondary">Clear</button>
      </div>

      <div style="margin-top:16px;display:flex;gap:8px;align-items:center">
        <div class="small"><strong>Backend:</strong> <span id="backendStatus">Unknown</span></div>
        <div style="flex:1"></div>
        <button id="healthCheck" class="btn secondary">Health Check</button>
      </div>

      <footer>
        Tip: If the frontend can't reach the backend, enable CORS in FastAPI or serve this file from the same origin as the API.
      </footer>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>Incoming Notifications</h1>
        <div class="controls">
          <select id="filterPriority">
            <option value="">All priorities</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
          </select>
          <input id="limit" type="number" min="1" max="200" value="10" style="width:86px;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03)" />
          <button id="refreshBtn" class="btn secondary">Refresh</button>
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <div id="toastPlaceholder" style="display:none"></div>

  <script>
    // Configuration
    const API_BASE = location.protocol + '//' + location.hostname + ':8000'; // assumes backend on port 8000

    // Elements
    const sourceEl = document.getElementById('source');
    const contentEl = document.getElementById('content');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const listEl = document.getElementById('list');
    const filterPriority = document.getElementById('filterPriority');
    const limitEl = document.getElementById('limit');
    const refreshBtn = document.getElementById('refreshBtn');
    const backendStatusEl = document.getElementById('backendStatus');
    const healthCheckBtn = document.getElementById('healthCheck');

    function toast(msg, time = 3000){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{t.remove()}, time);
    }

    async function checkHealth(){
      try{
        const res = await fetch(API_BASE + '/health');
        if(!res.ok) throw new Error('bad');
        const d = await res.json();
        backendStatusEl.textContent = d.status || 'healthy';
        backendStatusEl.style.color = '#82f3c4';
      }catch(e){
        backendStatusEl.textContent = 'unreachable';
        backendStatusEl.style.color = '#ff9b9b';
      }
    }

    async function sendNotification(){
      const source = sourceEl.value.trim();
      const content = contentEl.value.trim();
      if(!source || !content){ toast('Please provide both source and content'); return }
      sendBtn.disabled = true; sendBtn.textContent = 'Sending...';
      try{
        const res = await fetch(API_BASE + '/notifications/', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({source, content})
        });
        if(!res.ok){
          const err = await res.json().catch(()=>({detail:'Request failed'}));
          throw new Error(err.detail || 'Failed to send');
        }
        const data = await res.json();
        toast(`Sent — priority: ${data.priority}`);
        // reset and refresh list
        contentEl.value = '';
        await loadNotifications();
      }catch(err){
        console.error(err);
        toast('Error: ' + (err.message || 'unknown'));
      }finally{
        sendBtn.disabled = false; sendBtn.textContent = 'Send';
      }
    }

    function formatDate(iso){
      try{ const d = new Date(iso); return d.toLocaleString(); }catch(e){return iso}
    }

    async function loadNotifications(){
      listEl.innerHTML = '';
      const priority = filterPriority.value;
      const limit = Math.max(1, Math.min(200, parseInt(limitEl.value || '10')));
      let url = new URL(API_BASE + '/notifications/');
      url.searchParams.set('limit', limit);
      if(priority) url.searchParams.set('priority', priority);
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Failed to load');
        const arr = await res.json();
        if(arr.length === 0){
          listEl.innerHTML = '<div class="muted">No new notifications.</div>';
          return;
        }
        for(const n of arr){
          const item = document.createElement('div');
          item.className = 'item';

          const meta = document.createElement('div'); meta.className='meta';
          const src = document.createElement('div'); src.className='source'; src.textContent = n.source || 'Unknown';
          const cnt = document.createElement('div'); cnt.className='content'; cnt.textContent = n.content;
          const small = document.createElement('div'); small.className='small'; small.textContent = `Received: ${formatDate(n.received_at)}`;
          meta.appendChild(src); meta.appendChild(cnt); meta.appendChild(small);

          const right = document.createElement('div'); right.className='rightcol';
          const badge = document.createElement('div'); badge.className = 'badge ' + (n.priority || 'LOW'); badge.textContent = n.priority || 'LOW';
          const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px';

          const markBtn = document.createElement('button');
          markBtn.className='btn secondary'; markBtn.textContent='Mark Processed';
          markBtn.onclick = async ()=>{
            try{
              markBtn.disabled = true; markBtn.textContent = 'Processing...';
              const r = await fetch(API_BASE + `/notifications/${n.id}/processed`, {method:'PUT'});
              if(!r.ok) throw new Error('Not found');
              toast('Marked processed');
              await loadNotifications();
            }catch(err){
              toast('Error marking processed');
              markBtn.disabled = false; markBtn.textContent = 'Mark Processed';
            }
          };

          btns.appendChild(markBtn);
          right.appendChild(badge); right.appendChild(btns);

          item.appendChild(meta); item.appendChild(right);
          listEl.appendChild(item);
        }
      }catch(err){
        console.error(err);
        listEl.innerHTML = '<div class="muted">Could not load notifications — is the backend running and CORS enabled?</div>';
      }
    }

    // Event wiring
    sendBtn.addEventListener('click', sendNotification);
    clearBtn.addEventListener('click', ()=>{ sourceEl.value=''; contentEl.value=''; });
    refreshBtn.addEventListener('click', loadNotifications);
    filterPriority.addEventListener('change', loadNotifications);
    limitEl.addEventListener('change', loadNotifications);
    healthCheckBtn.addEventListener('click', checkHealth);

    // initial
    (async function(){
      await checkHealth();
      await loadNotifications();
    })();
  </script>
</body>
</html>
